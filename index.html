<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORM KETERLAMBATAN SISWA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* [CSS tetap sama seperti sebelumnya] */
    </style>
</head>
<body>
    <!-- [HTML struktur tetap sama seperti sebelumnya] -->

    <script>
        const form = document.getElementById("form-keterlambatan");
        const respon = document.getElementById("respon");
        const rekap = document.getElementById("rekap");
        const confettiContainer = document.getElementById("confetti-container");
        const successSound = document.getElementById("success-sound");
        const dataUrl = "https://script.google.com/macros/s/AKfycbx7dMvGRUCXdLD4wUrC0ic05RC6OzUuvgGuyu-pa4aTdLxpmyoxRFwOOYbOoLA2mVI/exec";
        const rekapUrl = dataUrl;
        const scanBtn = document.querySelector('.btn-scan');
        const stopBtn = document.querySelector('.btn-stop');
        const selectedStudentContainer = document.getElementById("selected-student-container");
        const selectedStudentName = document.getElementById("selected-student-name");
        const selectedStudentClass = document.getElementById("selected-student-class");
        const changeStudentBtn = document.getElementById("change-student-btn");
        const namaInput = document.getElementById("nama");
        const waktuInput = document.getElementById("waktu");
        const tanggalInput = document.getElementById("tanggal");
        
        let semuaSiswa = [];
        let html5QrCode = null;

        // Hapus set nilai default untuk tanggal dan waktu
        // Biarkan input kosong dan diisi manual oleh pengguna

        // Fungsi untuk validasi form
        function validateForm() {
            let isValid = true;
            
            // Validasi nama siswa
            if (!namaInput.value.trim()) {
                showMessage("❌ Nama siswa wajib diisi", "error");
                namaInput.focus();
                isValid = false;
            }
            
            // Validasi tanggal
            if (!tanggalInput.value) {
                showMessage("❌ Tanggal wajib diisi", "error");
                tanggalInput.focus();
                isValid = false;
            }
            
            // Validasi waktu
            if (!waktuInput.value) {
                showMessage("❌ Waktu keterlambatan wajib diisi", "error");
                waktuInput.focus();
                isValid = false;
            }
            
            return isValid;
        }

        // [Fungsi-fungsi lain tetap sama seperti sebelumnya...]

        // Event listener untuk form submit (diperbarui)
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            
            // Validasi form sebelum submit
            if (!validateForm()) {
                return;
            }
            
            const data = new FormData(form);
            const nama = data.get("nama");
            const tanggal = data.get("tanggal");
            
            // Cek apakah siswa sudah mengisi keterlambatan hari ini
            fetch(`${rekapUrl}?nama=${encodeURIComponent(nama)}&tanggal=${tanggal}`)
                .then(res => res.json())
                .then(data => {
                    if (data.sudah_isi) {
                        showMessage(`⚠️ ${nama} sudah mengisi keterlambatan hari ini (${tanggal}).`, "warning");
                        return;
                    }
                    
                    // Kirim data keterlambatan
                    fetch(dataUrl, {
                        method: "POST",
                        body: data
                    })
                    .then(response => response.text())
                    .then(text => {
                        showSuccessFeedback("✅ " + text);
                        form.reset();
                        hideSelectedStudent();
                    })
                    .catch(err => {
                        showMessage("❌ Gagal mengirim data.", "error");
                        console.error(err);
                    });
                })
                .catch(err => {
                    showMessage("❌ Gagal mengecek data sebelumnya.", "error");
                    console.error(err);
                });
        });

        // [Fungsi-fungsi lainnya tetap sama...]
    </script>
</body>
</html>